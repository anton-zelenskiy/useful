GET profiles/_search
{
  "query": {
    "match_all": {}
  }
}


GET proposals.proposals/_search
{
  "query": {
    "match": {
      "id": 20358589
    }
  }
}


# Bucket Sort test
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [88, 90, 91, 92, 93, 95, 98, 101, 102, 104, 7110, 7111, 34824, 35243]
          }
        },
        {
          "term" : {"user_country_id" : 1}
        }
      ],
      "should": [
        {"multi_match": {
          "query": "одежда",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "пальто",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "плащ",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "брюки",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "_source": ["id", "user_id"],
  "aggs" : {
    "areas" : {
        "geo_distance" : {
            "field" : "user_location",
            "origin" : {
              "lat": 51.20487, "lon": 58.56685
            },
            "unit": "km",
            "ranges" : [
              {"to" :   100, "key": "0-100"},
              {"from" : 100, "to": 500, "key": "100-500"},
              {"from" : 500, "key": "500-*"}
            ],
            "keyed": true
        },
        "aggs": {
          "uniq": {
            "cardinality": {
              "field": "user_id"
            }
          },
          "by_user": {
            "terms": {
              "field": "user_id",
              "size": 10000
            },
            "aggs": {
              "top_score": {
                "max": {
                  "script": "_score"
                }
              },
              "bucket_sort": {
                  "bucket_sort": {
                    "from": 0,
                    "size": 10
                }
              },
              "hits": {
                "top_hits": {
                  "from": 0,
                  "size": 1,
                  "_source": ["user_id", "user_origin_id"]
                }
              }
            }
          }
        }
    }
  }
}





# Bucket Sort test
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [88, 90, 91, 92, 93, 95, 98, 101, 102, 104, 7110, 7111, 34824, 35243]
          }
        },
        {
          "geo_distance" : {
              "distance" : "500km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 51.20487, "lon": 58.56685
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "одежда",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "пальто",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "плащ",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "брюки",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "_source": ["id", "user_id"],
  "aggs" : {
    "areas" : {
        "geo_distance" : {
            "field" : "user_location",
            "origin" : {
              "lat": 51.20487, "lon": 58.56685
            },
            "unit": "km",
            "ranges" : [
                {"from" : 0, "key": "500-*"}
            ],
            "keyed": true
        },
        "aggs": {
          "by_user": {
            "terms": {
              "field": "user_id",
              "size": 10000,
              "order": {
                "top_score": "desc"
              }
            },
            "aggs": {
              "top_score": {
                "max": {
                  "script": "_score"
                }
              },
              "bucket_sort": {
                  "bucket_sort": {
                    "from": 0,
                    "size": 10
                }
              },
              "hits": {
                "top_hits": {
                  "from": 0,
                  "size": 1,
                  "_source": ["user_id", "user_origin_id"]
                }
              }
            }
          }
        }
    }
  }
}


# Sampler
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [36,37,38,39,40,42,43,45,47,50,56,57,58,59,61,62,63,64,65,66,68,69,6033,32824,50438,50439,50440,50441,50442,50443,50444,50445,50541,50540,50539,50542,50544,50543,50545]
          }
        },
        {
          "geo_distance" : {
              "distance" : "50km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "масло motul",
          "fields": ["title"]
        }}
      ]
    }
  },
  "aggs": {
    "sample": {
      "sampler": {
        "shard_size": 100
      },
      "aggs": {
        "top_hits": {
          "top_hits": {
            "from": 0,
            "size": 100,
            "_source": ["id", "user_id", "title"]
          }
        }
      }
    }
  }
}


# Composite
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [36,37,38,39,40,42,43,45,47,50,56,57,58,59,61,62,63,64,65,66,68,69,6033,32824,50438,50439,50440,50441,50442,50443,50444,50445,50541,50540,50539,50542,50544,50543,50545]
          }
        },
        {
          "geo_distance" : {
              "distance" : "50km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "масло",
          "fields": ["title"]
        }}
      ]
    }
  },
  "aggs": {
    "buckets": {
      "composite": {
        "sources": [
          {
            "by_user": {
              "terms": {
                "field": "user_id"
              }
            }
          }
        ],
        "size": 10
      },
      "aggs": {
        "top_hits": {
          "top_hits": {
            "from": 0,
            "size": 1,
            "_source": ["id", "user_id", "user_origin_id"]
          }
        }
      }
    }
  }
}



# Bucket Sort
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [496,497,498,499,500,501,502,503,504,505,506,507,509,510,511,512,513,514,516,517,518,519,520,521,523,4334,32823,50460]
          }
        },
        {
          "geo_distance" : {
              "distance" : "500km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": " масло",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "_source": ["id", "user_id"],
  "aggs": {
    "uniq": {
      "cardinality": {
        "field": "user_id"
      }
    },
    "by_user": {
      "terms": {
        "field": "user_id",
        "size": 10000
      },
      "aggs": {
        "bucket_sort": {
            "bucket_sort": {
              "from": 0,
              "size": 10
          }
        },
        "hits": {
          "top_hits": {
            "from": 0,
            "size": 1,
            "_source": ["id", "user_id", "title"]
          }
        }
      }
    }
  }
}


# Bucket Sort (temp)
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [88, 90, 91, 92, 93, 95, 98, 101, 102, 104, 7110, 7111, 34824, 35243]
          }
        },
        {
          "geo_distance" : {
              "distance" : "500km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 51.20487, "lon": 58.56685
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "одежда",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "пальто",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "плащ",
          "fields": ["title"]
        }},
        {"multi_match": {
          "query": "брюки",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "_source": ["id", "user_id"],
  "aggs": {
    "by_user": {
      "terms": {
        "field": "user_id",
        "size": 10000
      },
      "aggs": {
        "rings": {
          "geo_distance" : {
              "field" : "user_location",
              "origin" : {
                "lat": 51.20487, "lon": 58.56685
              },
              "ranges" : [
                  { "to" : 100, "key": "first_ring" },
                  { "from" : 100, "key": "second_ring" }
              ],
              "unit" : "km"
          }
        },
        "bucket_sort": {
            "bucket_sort": {
              "from": 0,
              "size": 10
          }
        },
        "hits": {
          "top_hits": {
            "from": 0,
            "size": 1,
            "_source": ["user_id", "user_origin_id"]
          }
        }
      }
    }
  }
}



GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [36,37,38,39,40,42,43,45,47,50,56,57,58,59,61,62,63,64,65,66,68,69,6033,32824,50438,50439,50440,50441,50442,50443,50444,50445,50541,50540,50539,50542,50544,50543,50545]
          }
        },
        {
          "geo_distance" : {
              "distance" : "50km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "масло",
          "fields": ["title"]
        }}
      ]
    }
  },
  "_source": ["id", "user_id"],
  "aggs": {
    "by_user": {
      "terms": {
        "field": "user_id",
        "size": 10
      },
      "aggs": {
        "top_score": {
          "max": {
            "script": "_score"
          }
        },
        "top_hits": {
          "top_hits": {
            "from": 0,
            "size": 1,
            "_source": ["id", "user_id", "title"]
          }
        }
      }
    }
  }
}


# Partitions (partitioning is not predictable)
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [36,37,38,39,40,42,43,45,47,50,56,57,58,59,61,62,63,64,65,66,68,69,6033,32824,50438,50439,50440,50441,50442,50443,50444,50445,50541,50540,50539,50542,50544,50543,50545]
          }
        },
        {
          "geo_distance" : {
              "distance" : "50km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "масло",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "aggs": {
    "by_user": {
      "terms": {
        "field": "user_id",
        "include": {
          "partition": 0,
          "num_partitions": 10
        },
        "size": 10,
        "order": {
          "top_score": "desc"
        }
      },
      "aggs": {
        "top_score": {
          "max": {
            "script": "_score"
          }
        },
        "hits": {
          "top_hits": {
            "from": 0,
            "size": 1,
            "_source": ["id", "user_id", "title"]
          }
        }
      }
    }
  }
}




# Cardinality
GET proposals.proposals/_search
{
  "size": 0,
  "query": {
    "bool": {
      "filter": [
        {
          "terms": {
          "categories": [36,37,38,39,40,42,43,45,47,50,56,57,58,59,61,62,63,64,65,66,68,69,6033,32824,50438,50439,50440,50441,50442,50443,50444,50445,50541,50540,50539,50542,50544,50543,50545]
          }
        },
        {
          "geo_distance" : {
              "distance" : "50km",
              "distance_type": "plane",
              "user_location" : {
                "lat": 55.75222, "lon": 37.61556
              }
          }
        }
      ],
      "should": [
        {"multi_match": {
          "query": "масло",
          "fields": ["title"]
        }}
      ],
      "minimum_should_match": 1
    }
  },
  "_source": ["id", "user_id"],
  "aggs": {
    "bu_user": {
      "cardinality": {
        "field": "user_id"
      }
    }
  }
}

PUT proposals.categories/_settings
    {
    "index": {
    "blocks": {
    "read_only_allow_delete": "false"
    }
    }
    }


PUT proposals.proposals/_mapping
{
  "properties": {
    "user_country_id": {
      "type": "integer"
    }
  }
}

GET /_tasks?detailed=true&actions=*reindex

GET _cat/indices

GET _cat/shards?h=index,shard,prirep,state,unassigned.reason

GET _cluster/health

GET _cluster/settings

GET _nodes/stats

GET proposals.proposals/_settings

GET /_cluster/allocation/explain

POST /_cluster/reroute?retry_failed=true

DELETE .kibana_task_manager

PUT _cluster/settings
{
  "persistent": {
    "xpack.monitoring.collection.enabled": true
  }
}

POST _reindex
{
  "conflicts": "proceed",
  "source": {
    "remote": {
      "host": "http://10.100.0.102:9207"
    },
    "index": "proposals.proposals",
    "query": {
      "match_all": {}
    }
  },
  "dest": {
    "index": "proposals.proposals"
  }
}
