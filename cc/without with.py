SELECT DISTINCT leads.id, users.cold_lead_efficiency_coefficient FROM callerspanel_lead AS leads

INNER JOIN users_user AS users
ON (users.id = leads.user_id)

-- JOIN на рубрики
LEFT JOIN users_userrubric AS u_rub ON
(users.id = u_rub.user_id)

LEFT JOIN rubrics_rubric AS rubrics ON
(u_rub.rubric_id = rubrics.id)

-- JOIN на origin
LEFT JOIN regions_region AS origin ON
(users.origin_id = origin.id)

LEFT JOIN marketing_sourceinfo AS source_info ON
(source_info.object_type_id = 12 AND users.id = source_info.object_id)

-- JOIN-ы на доп выборки

LEFT JOIN (
    SELECT DISTINCT supplier_leads.user_id AS id FROM supplier_leads

INNER JOIN (
    SELECT logs.lead_id FROM supplier_logs AS logs
WHERE logs.created_at >= '2019-10-25 10:47:23.318646+00:00'
) AS logs ON (logs.lead_id = supplier_leads.id)

WHERE supplier_leads.user_id IS NOT NULL
) AS with_supplier_panel_calls ON
(users.id = with_supplier_panel_calls.id)

LEFT JOIN (
    SELECT sales_planned_call.user_id AS id
FROM sales_planned_call
WHERE (
    planned_datetime > '2020-04-22 10:47:23.318646+00:00'
AND sales_planned_call.user_id IS NOT NULL
)
) AS with_sales_planned_calls ON
(users.id = with_sales_planned_calls.id)

LEFT JOIN (
    SELECT callerspanel_lead.user_id AS id
FROM callerspanel_lead
WHERE (
    callerspanel_lead.planned_call_dt > '2020-04-22 10:47:23.318646+00:00'
AND callerspanel_lead.crm_type = 1
)
) AS with_ro_planned_calls ON
(users.id = with_ro_planned_calls.id)

LEFT JOIN (
    SELECT sales_lead.user_id AS id
FROM action_on_sales_lead as asl
INNER JOIN sales_lead ON (asl.lead_id = sales_lead.id)
WHERE asl.processed_at > '2019-10-25 10:47:23.318646+00:00'
GROUP BY asl.id, sales_lead.user_id
HAVING SUM (asl.duration) > 5
) AS with_sales_call_duration ON
(users.id = with_sales_call_duration.id)

LEFT JOIN (
    SELECT lead.user_id AS id
FROM callerspanel_lead AS lead
INNER JOIN callerspanel_leadactionlog AS lead_logs ON (
    lead_logs.lead_id = lead.id
)
WHERE (
    lead.user_content_type_id = 12 AND
lead.crm_type = 1
) AND
lead_logs.created_at >= current_timestamp - interval '0' DAY
) AS with_calls_from_ro_panel ON
(users.id = with_calls_from_ro_panel.id)

LEFT JOIN (
    SELECT orders_order.user_id AS id FROM orders_order
WHERE
orders_order.actualized_at > '2019-10-25 10:47:23.318646+00:00'
AND orders_order.user_id IS NOT NULL
) AS with_orders ON
(users.id = with_orders.id)

-- JOIN на company_profile
INNER JOIN users_companyprofile AS companyprofile ON
(users.company_profile_id = companyprofile.id)

WHERE

with_supplier_panel_calls.id IS NULL
AND with_sales_planned_calls.id IS NULL
AND with_ro_planned_calls.id IS NULL
AND with_sales_call_duration.id IS NULL
AND with_calls_from_ro_panel.id IS NULL
AND with_orders.id IS NULL
AND users.is_staff = FALSE
AND users.is_superuser = FALSE
AND leads.crm_type = 0
AND leads.status = 999
AND leads.user_content_type_id = 12
AND rubrics.visible = TRUE

-- невалидные юзеры по дате логина или изменения источника
AND NOT (
    (source_info.source = 'cold_customer' AND source_info.activity_date < '2019-10-25 10:47:23.318646+00:00')
OR
(users.date_joined < '2019-10-25 10:47:23.318646+00:00' AND source_info.source = 'cold_customer')
)

-- фильтр для того, чтобы не выдавать древние спарсенные неактуальные компании
AND users.last_login > '2016-01-01'

-- исключаем в зависимости от настройки группы, у кого нет сайта,
AND ( true OR (companyprofile.site IS NOT NULL AND companyprofile.site <> ''))

AND u_rub.rubric_id NOT IN (1794, 1835, 4620, 4631, 4622, 4635, 4624, 4621, 4623, 4630, 4632, 9106, 4627, 4629, 4638, 4626, 4634, 4625, 4639, 9638, 4636, 1837, 3367, 4920, 4921, 4936, 4922, 4924, 4923, 4925, 4926, 4927, 4928, 4929, 4942, 4930, 4931, 4941, 4932, 4940, 4933, 4938, 4939, 4937, 4934, 4935, 4984, 4969, 4961, 4959, 4967, 4970, 4993, 4956, 4949, 4972, 4944, 4957, 4958, 4955, 4960, 4943, 4990, 4975, 4962, 4979, 4988, 4989, 4987, 4986, 4963, 4948, 4992, 4985, 4965, 4966, 4968, 4953, 4950, 4973, 4976, 4974, 4945, 4971, 4982, 4991, 4964, 4978, 4980, 4981, 4983, 4951, 4952, 4947, 4977, 4954, 1858, 4995, 5001, 4996, 4997, 4998, 4999, 5002, 5003, 5004, 5005, 5006, 5007, 5008, 5009, 5010, 5011, 5012, 5013, 5014, 5015, 5016, 5018, 5019, 5020, 5021, 5022, 5023, 5024, 5025, 5026, 5027, 5028, 5029, 5030, 5031, 5032, 5034, 5033, 5035, 5036, 5037, 5038, 5039, 5040, 5041, 5042, 5043, 5044, 5045, 5046, 5047, 5048, 5049, 5050, 5051, 5052, 9861, 9858, 5053, 5109, 5094, 5086, 5054, 5084, 5055, 5092, 5095, 5056, 5118, 5081, 5074, 5057, 5097, 5069, 5082, 5083, 5080, 5085, 5068, 5115, 5100, 5058, 5059, 5060, 5087, 5104, 5113, 5114, 5112, 5111, 5061, 5088, 5073, 5062, 5117, 5110, 5090, 5063, 5091, 5093, 5078, 5075, 5098, 5101, 5099, 5070, 5096, 5107, 5116, 5089, 5064, 5103, 5105, 5106, 5108, 5076, 5077, 5065, 5066, 5072, 5102, 5079, 5067, 3368, 5138, 5120, 5129, 5121, 5130, 5143, 5144, 5139, 5140, 5141, 5122, 5142, 5124, 5123, 5132, 5131, 5133, 5125, 5126, 5134, 5145, 5135, 5146, 5127, 5128, 5137, 5136, 5188, 5173, 5165, 5163, 5171, 5174, 5197, 5160, 5153, 5176, 5148, 5161, 5162, 5159, 5164, 5147, 5194, 5179, 5166, 5183, 5192, 5193, 5191, 5190, 5167, 5152, 5196, 5189, 5169, 5170, 5172, 5157, 5154, 5177, 5180, 5178, 5149, 5175, 5186, 5195, 5168, 5182, 5184, 5185, 5187, 5155, 5156, 5151, 5181, 5158, 3369, 5200, 5201, 5202, 5203, 5204, 5207, 5208, 5212, 5211, 5209, 5205, 5210, 5206, 5254, 5239, 5231, 5229, 5237, 5240, 5263, 5226, 5219, 5242, 5214, 5227, 5228, 5225, 5230, 5213, 5260, 5245, 5232, 5249, 5258, 5259, 5257, 5256, 5233, 5218, 5262, 5255, 5235, 5236, 5238, 5223, 5220, 5243, 5246, 5244, 5215, 5241, 5252, 5261, 5234, 5248, 5250, 5251, 5253, 5221, 5222, 5217, 5247, 5224, 3365, 5271, 5265, 5266, 5267, 5270, 5269, 5313, 5298, 5290, 5288, 5296, 5299, 5322, 5285, 5278, 5301, 5273, 5286, 5287, 5284, 5289, 5272, 5319, 5304, 5291, 5308, 5317, 5318, 5316, 5315, 5292, 5277, 5321, 5314, 5294, 5295, 5297, 5282, 5279, 5302, 5305, 5303, 5274, 5300, 5311, 5320, 5293, 5307, 5309, 5310, 5312, 5280, 5281, 5276, 5306, 5283, 1850, 5332, 5326, 5377, 5362, 5354, 5352, 5360, 5363, 5386, 5330, 5349, 5342, 5325, 5365, 5337, 5350, 5351, 5348, 5331, 5353, 5336, 5383, 5368, 5327, 5333, 5324, 5355, 5372, 5381, 5382, 5380, 5379, 5356, 5341, 5385, 5378, 5334, 5358, 5359, 5361, 5346, 5343, 5366, 5369, 5367, 5329, 5338, 5364, 5375, 5384, 5335, 5357, 5371, 5373, 5374, 5376, 5344, 5345, 5328, 5340, 5370, 5347, 3366, 5388, 5403, 5389, 5390, 5402, 5392, 5393, 5394, 5395, 5396, 5397, 5405, 5398, 5404, 5399, 5400, 5401, 5447, 5432, 5424, 5422, 5430, 5433, 5456, 5419, 5412, 5435, 5407, 5420, 5421, 5418, 5423, 5406, 5453, 5438, 5425, 5442, 5451, 5452, 5450, 5449, 5426, 5411, 5455, 5448, 5428, 5429, 5431, 5416, 5413, 5436, 5439, 5437, 5408, 5434, 5445, 5454, 5427, 5441, 5443, 5444, 5446, 5414, 5415, 5410, 5440, 5417, 1874, 4868, 4866, 4867, 1875, 4893, 4892, 4894, 4895, 1878, 1866, 4796, 4755, 4811, 4737, 4664, 4746, 4670, 4764, 4738, 4665, 4747, 4666, 4765, 4760, 4641, 4766, 4642, 4657, 4667, 4767, 4643, 4645, 4761, 4644, 4783, 4671, 4797, 4798, 4792, 4646, 4810, 4673, 4674, 4647, 4675, 4756, 4676, 4648, 4677, 4649, 4679, 4771, 4650, 4777, 4772, 4681, 4800, 4776, 4682, 4775, 4663, 4683, 4801, 4684, 4651, 4685, 4758, 4687, 4739, 4652, 4689, 4690, 4691, 4786, 4759, 4741, 4692, 4693, 4662, 4803, 4773, 4653, 4694, 4695, 4748, 4696, 4697, 4742, 4743, 4698, 4813, 4661, 4699, 4654, 4700, 4701, 4659, 4703, 4702, 4704, 4752, 4782, 4705, 4660, 4706, 4707, 4744, 4708, 4745, 4658, 4709, 4655, 4754, 4710, 4769, 4711, 4781, 4712, 4713, 4807, 4808, 4714, 4715, 4716, 4656, 4717, 4718, 4719, 4720, 4721, 4774, 4770, 4722, 4855, 4840, 4832, 4723, 4830, 4724, 4838, 4841, 4725, 4864, 4790, 4827, 4820, 4726, 4843, 4815, 4828, 4829, 4826, 4791, 4831, 4814, 4861, 4846, 4727, 4728, 4793, 4784, 4833, 4850, 4859, 4860, 4858, 4857, 4730, 4834, 4819, 4731, 4863, 4856, 4794, 4836, 4732, 4837, 4839, 4824, 4821, 4844, 4847, 4845, 4789, 4816, 4842, 4853, 4862, 4795, 4835, 4733, 4849, 4851, 4852, 4854, 4822, 4823, 4734, 4735, 4818, 4848, 4825, 4736, 1864, 4914, 9580, 4902, 4906, 4900, 4905, 4917, 4904, 4899, 4898, 9578, 4896, 4916, 4918, 4907, 4908, 4909, 4910, 4915, 9579, 4911, 4912, 4913, 4901, 4903, 9690, 1853, 4887, 4889, 4888, 4890, 1880, 3310, 4870, 4876, 4877, 4874, 4881, 4880, 4873, 4872, 4878, 4879, 4882, 4885, 4883, 4884, 4875, 4871, 1839, 5459, 5460, 5461, 5458, 5463, 5462, 1831, 9946, 1843, 1840, 5499, 6257, 6264, 6262, 6263, 6258, 6265, 6260, 6259, 6261, 3619, 6271, 6270, 6268, 6266, 6267, 6269, 1851, 6272, 6273, 6274, 6275, 6276, 6277, 6278, 6279, 6280, 6281, 6283, 6284, 6285, 6287, 6288, 6289, 6290, 6291, 6292, 6293, 6294, 6295, 6296, 6297, 6298, 6299, 6300, 6301, 6365, 6350, 6342, 6340, 6302, 6348, 6303, 6351, 6374, 6304, 6337, 6330, 6353, 6325, 6338, 6339, 6336, 6305, 6341, 6324, 6371, 6356, 6306, 6307, 6308, 6343, 6360, 6369, 6370, 6368, 6367, 6309, 6344, 6329, 6310, 6311, 6312, 6313, 6314, 6373, 6366, 6346, 6315, 6316, 6317, 6318, 6347, 6349, 6334, 6319, 6331, 6354, 6357, 6320, 6355, 6326, 6352, 6363, 6372, 6345, 6359, 6361, 6362, 6364, 6332, 6333, 6321, 6322, 6323, 6328, 6358, 6335, 3311, 6375, 6376, 6377, 6378, 6379, 6380, 6381, 6382, 6383, 6384, 6385, 6386, 6387, 6388, 6389, 6390, 6391, 6392, 6393, 6394, 6395, 6396, 6397, 6398, 6400, 6399, 6401, 6402, 6403, 6404, 6405, 6406, 6407, 6408, 6409, 6410, 6411, 6412, 6413, 6414, 6415, 6416, 6859, 6844, 6836, 6834, 6842, 6845, 6868, 6831, 6824, 6417, 6418, 6847, 6427, 6832, 6833, 6830, 6835, 6426, 6865, 6850, 6419, 6837, 6854, 6863, 6864, 6420, 6862, 6861, 6838, 6823, 6421, 6867, 6860, 6840, 6841, 6843, 6828, 6422, 6825, 6848, 6851, 6849, 6428, 6846, 6857, 6866, 6839, 6853, 6855, 6856, 6858, 6826, 6827, 6423, 6424, 6822, 6852, 6829, 6425, 1867, 7004, 6973, 7014, 6960, 6892, 6968, 6897, 6979, 6961, 6893, 6969, 6894, 6980, 6977, 6869, 6981, 6870, 6885, 6895, 6982, 6871, 6873, 6978, 6872, 6994, 6898, 7005, 7006, 7000, 6874, 7013, 6899, 6900, 6875, 6901, 6974, 6902, 6876, 6903, 6877, 6904, 6985, 6878, 6991, 6986, 6905, 7008, 6990, 6906, 6989, 6891, 6907, 7009, 6908, 6879, 6909, 6975, 6911, 6962, 6880, 6912, 6913, 6914, 6996, 6976, 6963, 6915, 6916, 6890, 7010, 6987, 6881, 6917, 6918, 6970, 6919, 6920, 6964, 6965, 6921, 7015, 6889, 6922, 6882, 6923, 6924, 6887, 6926, 6925, 6927, 6971, 6993, 6928, 6888, 6929, 6930, 6966, 6931, 6967, 6886, 6932, 6883, 6972, 6933, 6983, 6934, 6992, 6935, 6936, 7011, 7012, 6937, 6938, 6939, 6884, 6940, 6941, 6942, 6943, 6944, 6988, 6984, 6945, 7057, 7042, 7034, 6946, 7032, 6947, 7040, 7043, 6948, 7066, 6998, 7029, 7022, 6949, 7045, 7017, 7030, 7031, 7028, 6999, 7033, 7016, 7063, 7048, 6950, 6951, 7001, 6995, 7035, 7052, 7061, 7062, 7060, 7059, 6953, 7036, 7021, 6954, 7065, 7058, 7002, 7038, 6955, 7039, 7041, 7026, 7023, 7046, 7049, 7047, 6997, 7018, 7044, 7055, 7064, 7003, 7037, 6956, 7051, 7053, 7054, 7056, 7024, 7025, 6957, 6958, 7020, 7050, 7027, 6959, 6147, 7141, 7152, 7143, 7156, 7145, 7142, 7144, 7151, 7153, 9543, 7148, 7150, 7159, 7147, 7155, 7146, 7160, 9639, 7157, 3572, 7067, 7068, 7083, 7069, 7071, 7070, 7072, 7073, 7074, 7075, 7076, 7089, 7077, 7078, 7088, 7079, 7087, 7080, 7085, 7086, 7084, 7081, 7082, 7131, 7116, 7108, 7106, 7114, 7117, 7140, 7103, 7096, 7119, 7091, 7104, 7105, 7102, 7107, 7090, 7137, 7122, 7109, 7126, 7135, 7136, 7134, 7133, 7110, 7095, 7139, 7132, 7112, 7113, 7115, 7100, 7097, 7120, 7123, 7121, 7092, 7118, 7129, 7138, 7111, 7125, 7127, 7128, 7130, 7098, 7099, 7094, 7124, 7101, 3594, 7161, 7167, 7162, 7163, 7164, 7165, 7168, 7169, 7170, 7171, 7172, 7173, 7174, 7175, 7176, 7177, 7178, 7179, 7180, 7181, 7182, 7184, 7185, 7186, 7187, 7188, 7189, 7190, 7191, 7192, 7193, 7194, 7195, 7196, 7197, 7198, 7200, 7199, 7201, 7202, 7203, 7204, 7205, 7206, 7207, 7208, 7209, 7210, 7211, 7212, 7213, 7214, 7215, 7216, 7217, 7218, 9860, 9859, 7219, 7275, 7260, 7252, 7220, 7250, 7221, 7258, 7261, 7222, 7284, 7247, 7240, 7223, 7263, 7235, 7248, 7249, 7246, 7251, 7234, 7281, 7266, 7224, 7225, 7226, 7253, 7270, 7279, 7280, 7278, 7277, 7227, 7254, 7239, 7228, 7283, 7276, 7256, 7229, 7257, 7259, 7244, 7241, 7264, 7267, 7265, 7236, 7262, 7273, 7282, 7255, 7230, 7269, 7271, 7272, 7274, 7242, 7243, 7231, 7232, 7238, 7268, 7245, 7233, 3573, 7303, 7285, 7294, 7286, 7295, 7308, 7309, 7304, 7305, 7306, 7287, 7307, 7289, 7288, 7297, 7296, 7298, 7290, 7291, 7299, 7310, 7300, 7311, 7292, 7293, 7302, 7301, 7353, 7338, 7330, 7328, 7336, 7339, 7362, 7325, 7318, 7341, 7313, 7326, 7327, 7324, 7329, 7312, 7359, 7344, 7331, 7348, 7357, 7358, 7356, 7355, 7332, 7317, 7361, 7354, 7334, 7335, 7337, 7322, 7319, 7342, 7345, 7343, 7314, 7340, 7351, 7360, 7333, 7347, 7349, 7350, 7352, 7320, 7321, 7316, 7346, 7323, 3574, 7363, 7364, 7365, 7366, 7367, 7370, 7371, 7375, 7374, 7372, 7368, 7373, 7369, 7417, 7402, 7394, 7392, 7400, 7403, 7426, 7389, 7382, 7405, 7377, 7390, 7391, 7388, 7393, 7376, 7423, 7408, 7395, 7412, 7421, 7422, 7420, 7419, 7396, 7381, 7425, 7418, 7398, 7399, 7401, 7386, 7383, 7406, 7409, 7407, 7378, 7404, 7415, 7424, 7397, 7411, 7413, 7414, 7416, 7384, 7385, 7380, 7410, 7387, 3570, 7433, 7427, 7428, 7429, 7432, 7431, 7475, 7460, 7452, 7450, 7458, 7461, 7484, 7447, 7440, 7463, 7435, 7448, 7449, 7446, 7451, 7434, 7481, 7466, 7453, 7470, 7479, 7480, 7478, 7477, 7454, 7439, 7483, 7476, 7456, 7457, 7459, 7444, 7441, 7464, 7467, 7465, 7436, 7462, 7473, 7482, 7455, 7469, 7471, 7472, 7474, 7442, 7443, 7438, 7468, 7445, 3592, 7493, 7487, 7538, 7523, 7515, 7513, 7521, 7524, 7547, 7491, 7510, 7503, 7486, 7526, 7498, 7511, 7512, 7509, 7492, 7514, 7497, 7544, 7529, 7488, 7494, 7485, 7516, 7533, 7542, 7543, 7541, 7540, 7517, 7502, 7546, 7539, 7495, 7519, 7520, 7522, 7507, 7504, 7527, 7530, 7528, 7490, 7499, 7525, 7536, 7545, 7496, 7518, 7532, 7534, 7535, 7537, 7505, 7506, 7489, 7501, 7531, 7508, 3571, 7548, 7563, 7549, 7550, 7562, 7552, 7553, 7554, 7555, 7556, 7557, 7565, 7558, 7564, 7559, 7560, 7561, 7607, 7592, 7584, 7582, 7590, 7593, 7616, 7579, 7572, 7595, 7567, 7580, 7581, 7578, 7583, 7566, 7613, 7598, 7585, 7602, 7611, 7612, 7610, 7609, 7586, 7571, 7615, 7608, 7588, 7589, 7591, 7576, 7573, 7596, 7599, 7597, 7568, 7594, 7605, 7614, 7587, 7601, 7603, 7604, 7606, 7574, 7575, 7570, 7600, 7577, 3419, 7619, 7617, 7618, 9691, 3418, 7620, 7626, 7627, 7624, 7631, 7630, 7623, 7622, 7628, 7629, 7632, 7635, 7633, 7634, 7625, 7621, 3417, 7637, 7638, 7639, 7636, 7641, 7640, 3422, 7642, 7643, 7644, 7645, 7646, 7647, 7648, 7649, 7650, 7651, 7653, 7654, 7655, 7657, 7658, 7659, 7660, 7661, 7662, 7663, 7664, 7665, 7666, 7667, 7668, 7669, 7670, 7671, 7735, 7720, 7712, 7710, 7672, 7718, 7673, 7721, 7744, 7674, 7707, 7700, 7723, 7695, 7708, 7709, 7706, 7675, 7711, 7694, 7741, 7726, 7676, 7677, 7678, 7713, 7730, 7739, 7740, 7738, 7737, 7679, 7714, 7699, 7680, 7681, 7682, 7683, 7684, 7743, 7736, 7716, 7685, 7686, 7687, 7688, 7717, 7719, 7704, 7689, 7701, 7724, 7727, 7690, 7725, 7696, 7722, 7733, 7742, 7715, 7729, 7731, 7732, 7734, 7702, 7703, 7691, 7692, 7693, 7698, 7728, 7705, 3420, 7745, 7746, 7747, 7748, 7749, 7750, 7751, 7752, 7753, 7754, 7755, 7756, 7757, 7758, 7759, 7760, 7761, 7762, 7763, 7764, 7765, 7766, 7767, 7768, 7770, 7769, 7771, 7772, 7773, 7774, 7775, 7776, 7777, 7778, 7779, 7780, 7781, 7782, 7783, 7784, 7785, 7786, 7837, 7822, 7814, 7812, 7820, 7823, 7846, 7809, 7802, 7787, 7788, 7825, 7797, 7810, 7811, 7808, 7813, 7796, 7843, 7828, 7789, 7815, 7832, 7841, 7842, 7790, 7840, 7839, 7816, 7801, 7791, 7845, 7838, 7818, 7819, 7821, 7806, 7792, 7803, 7826, 7829, 7827, 7798, 7824, 7835, 7844, 7817, 7831, 7833, 7834, 7836, 7804, 7805, 7793, 7794, 7800, 7830, 7807, 7795, 3421, 7982, 7951, 7992, 7938, 7870, 7946, 7875, 7957, 7939, 7871, 7947, 7872, 7958, 7955, 7847, 7959, 7848, 7863, 7873, 7960, 7849, 7851, 7956, 7850, 7972, 7876, 7983, 7984, 7978, 7852, 7991, 7877, 7878, 7853, 7879, 7952, 7880, 7854, 7881, 7855, 7882, 7963, 7856, 7969, 7964, 7883, 7986, 7968, 7884, 7967, 7869, 7885, 7987, 7886, 7857, 7887, 7953, 7889, 7940, 7858, 7890, 7891, 7892, 7974, 7954, 7941, 7893, 7894, 7868, 7988, 7965, 7859, 7895, 7896, 7948, 7897, 7898, 7942, 7943, 7899, 7993, 7867, 7900, 7860, 7901, 7902, 7865, 7904, 7903, 7905, 7949, 7971, 7906, 7866, 7907, 7908, 7944, 7909, 7945, 7864, 7910, 7861, 7950, 7911, 7961, 7912, 7970, 7913, 7914, 7989, 7990, 7915, 7916, 7917, 7862, 7918, 7919, 7920, 7921, 7922, 7966, 7962, 7923, 8035, 8020, 8012, 7924, 8010, 7925, 8018, 8021, 7926, 8044, 7976, 8007, 8000, 7927, 8023, 7995, 8008, 8009, 8006, 7977, 8011, 7994, 8041, 8026, 7928, 7929, 7979, 7930, 7973, 8013, 8030, 8039, 8040, 8038, 8037, 7931, 8014, 7999, 7932, 8043, 8036, 7980, 8016, 7933, 8017, 8019, 8004, 8001, 8024, 8027, 8025, 7975, 7996, 8022, 8033, 8042, 7981, 8015, 7934, 8029, 8031, 8032, 8034, 8002, 8003, 7935, 7936, 7998, 8028, 8005, 7937, 1862, 1848, 1869, 8051, 8047, 8052, 8059, 8054, 8046, 8055, 8056, 8058, 8053, 8057, 8049, 1877, 1849, 1847, 1846, 1854, 1841, 1796, 1931, 1973, 3336, 3329, 3333, 1960, 1942, 1954, 3332, 3331, 1934, 3334, 1958, 1951, 3330, 8611, 8612, 8613, 8614, 8615, 8616, 8617, 8618, 8619, 8620, 1965, 1937, 1952, 3335, 1946, 1967, 1802, 3282, 3281, 2208, 3277, 9496, 9498, 9499, 9497, 9760, 2186, 9885, 9886, 9884, 10005, 3602, 2162, 9503, 9508, 9507, 9505, 9506, 9504, 3276, 9515, 9520, 9516, 9517, 9518, 9519, 3275, 2160, 9701, 9524, 9522, 9521, 9525, 9523, 9526, 3384, 9500, 9822, 9502, 9883, 9501, 9761, 3385, 3386, 9509, 9514, 9513, 9511, 9512, 9510, 3387, 9700, 9530, 9528, 9527, 9531, 9838, 9529, 9532, 3388, 3278, 9533, 9534, 9535, 9536, 2183, 2146, 2176, 3284, 2161, 2178, 2199, 2210, 2202, 2182, 2133, 3283, 3280, 9869, 9840, 1800, 2080, 3607, 2096, 2081, 2090, 1797, 1979, 2000, 1995, 2004, 3251, 2008, 1994, 2018, 1999, 3254, 3005, 2009, 1977, 3250, 9482, 9484, 9485, 9483, 9486, 9479, 9480, 9478, 9481, 9477, 9551, 2068, 2013, 3575, 9491, 9493, 9494, 9492, 9495, 9489, 9490, 9488, 9487, 9552, 1993, 2014, 2011, 1992, 3249, 1997, 1998, 1986, 2012, 3253, 2010, 3255, 3252, 2066, 1988, 1798, 3343, 9469, 9470, 9471, 9472, 9473, 9474, 8872, 2050, 2022, 2259, 2042, 3344, 2047, 3346, 9475, 9476, 2035, 2048, 2023, 2046, 1799, 2061, 9346, 9351, 9345, 9354, 9348, 9353, 9352, 9349, 9350, 9344, 9347, 2060, 9719, 9376, 9730, 9372, 9369, 9370, 9377, 9715, 9722, 9718, 9374, 9366, 9373, 9375, 9371, 9726, 9367, 9727, 9734, 9723, 9731, 9368, 3604, 2062, 9394, 9397, 9398, 9396, 9399, 9391, 9392, 9400, 9402, 9393, 9401, 9617, 9395, 9390, 2053, 9418, 9417, 9416, 3378, 9357, 9362, 9356, 9365, 9941, 9359, 9364, 9363, 9360, 9361, 9355, 9358, 3376, 9720, 9388, 9729, 9384, 9381, 9382, 9389, 9716, 9721, 9717, 9386, 9378, 9385, 9387, 9383, 9725, 9379, 9728, 9733, 9724, 9732, 9380, 3605, 3377, 9407, 9410, 9411, 9409, 9412, 9404, 9405, 9413, 9415, 9406, 9414, 9618, 9408, 9403, 3380, 9421, 9420, 9419, 3379, 9435, 9430, 9434, 9431, 9432, 9433, 3382, 9450, 9454, 9449, 9452, 9453, 9451, 3381, 9463, 9465, 9462, 9464, 9468, 9467, 9466, 3256, 9428, 9427, 9422, 9426, 9423, 9429, 9424, 9425, 2071, 9437, 9436, 9438, 2057, 3257, 9439, 9440, 9441, 9442, 2059, 9444, 9448, 9443, 9446, 9447, 9445, 2069, 9456, 9458, 9455, 9457, 9461, 9460, 9459, 1801, 2120, 2122, 2105, 9210, 9209, 9211, 2114, 2100, 9216, 9215, 9217, 2113, 2110, 2116, 9222, 9227, 9225, 9223, 9224, 9226, 2112, 9235, 9234, 9236, 9237, 9238, 9239, 2103, 9249, 9248, 9246, 9247, 2107, 2118, 9258, 9254, 9256, 9257, 9255, 2117, 9267, 9264, 9265, 9266, 9996, 2115, 9798, 9287, 9289, 9288, 2106, 9297, 9302, 9295, 9300, 9299, 9301, 9298, 9296, 9294, 2101, 9312, 9314, 9313, 2124, 9278, 9276, 9272, 9274, 9273, 9275, 9277, 2104, 9321, 9993, 9320, 9322, 9319, 2102, 9327, 9328, 3565, 9213, 9212, 9214, 3508, 3502, 9219, 9218, 9220, 3503, 3504, 3510, 9228, 9233, 9231, 9229, 9230, 9232, 3596, 9241, 9240, 9242, 9243, 9244, 9245, 3511, 9253, 9252, 9250, 9251, 3505, 3506, 9263, 9259, 9261, 9262, 9260, 3507, 9271, 9268, 9269, 9270, 9995, 3566, 9797, 9291, 9293, 9292, 3567, 9306, 9311, 9304, 9309, 9308, 9310, 9307, 9305, 9303, 3568, 9315, 9317, 9316, 3595, 9285, 9283, 9279, 9281, 9280, 9282, 9284, 3509, 9325, 9994, 9324, 9326, 9323, 3569, 9329, 9330, 3512, 9340, 9343, 9342, 9341, 2121, 2119, 9333, 9334, 9332, 9335, 9785, 9331, 2108, 9336, 9339, 9338, 9337, 2125, 2237, 8261, 8258, 8262, 8264, 8263, 8259, 8260, 2232, 2245, 1807, 2428, 2434, 2426, 3500, 2425, 2422, 3350, 9102, 9103, 9105, 9104, 2430, 9110, 9112, 9111, 9109, 2424, 2433, 2429, 2427, 1809, 3622, 5484, 5485, 5496, 5489, 5486, 5494, 5487, 5488, 5491, 5493, 5492, 5495, 5490, 2492, 6148, 6459, 6453, 6462, 6458, 6456, 6454, 6461, 6464, 6463, 6455, 6460, 6457, 6465, 2478, 2497, 8062, 8063, 8061, 8064, 2486, 8066, 8065, 8067, 3266, 2500, 9586, 8079, 8076, 8735, 9647, 9588, 8069, 8075, 8072, 8071, 9587, 9743, 8081, 8083, 9571, 8080, 8077, 8074, 8078, 8070, 9545, 8068, 8073, 8251, 8082, 2481, 2515, 2474, 2526, 2519, 8093, 8091, 8084, 8085, 8087, 8086, 8088, 8089, 8090, 8092, 3274, 3237, 8108, 8101, 8107, 8096, 8117, 8095, 8106, 8114, 8094, 8100, 8116, 8112, 8109, 8111, 8097, 8115, 8103, 8110, 8098, 8104, 8099, 8113, 8102, 8105, 2487, 5505, 8125, 8126, 8123, 8122, 8134, 8135, 8119, 8124, 8137, 8132, 9688, 8118, 8120, 8131, 8133, 8121, 8136, 8129, 9573, 8130, 8127, 8128, 3620, 8140, 8139, 8138, 8645, 8644, 2510, 8142, 8146, 8143, 8144, 8145, 8141, 2523, 8150, 8149, 8147, 8148, 2516, 3272, 8153, 8151, 8152, 8157, 8154, 8156, 8158, 8155, 3373, 6467, 6468, 6466, 3270, 6474, 6472, 6473, 6469, 6470, 6471, 3374, 6475, 6476, 3375, 3273, 2521, 2501, 6478, 6479, 6480, 6477, 2857, 2477, 2489, 5517, 6483, 6484, 6481, 6482, 2490, 2524, 2503, 8194, 8206, 8203, 8196, 8202, 8199, 8198, 8208, 3614, 8207, 8204, 8201, 8205, 8197, 8195, 8200, 8209, 2482, 2525, 8734, 2488, 8166, 8169, 8171, 9632, 9633, 8163, 8170, 8164, 9537, 8168, 8167, 8165, 3268, 2511, 5476, 5471, 5472, 5469, 5468, 5480, 5481, 5465, 5470, 5478, 9689, 5464, 5466, 5477, 5479, 5467, 5482, 5475, 5473, 5474, 2509, 8398, 6485, 6487, 6486, 6488, 3606, 5498, 5497, 1815, 9560, 9564, 9565, 9563, 9568, 9561, 9567, 9566, 2753, 2763, 2765, 2773, 9077, 9078, 9079, 3464, 3462, 9895, 9896, 10010, 2767, 9696, 9771, 9772, 9773, 9774, 9775, 3459, 9091, 9092, 3460, 9093, 9094, 9559, 10008, 9882, 3463, 3461, 3339, 9082, 9080, 9081, 2758, 9083, 9084, 3338, 3608, 9088, 4633, 9085, 9086, 9087, 2747, 9089, 9090, 2754, 3071, 3340, 2769, 9095, 3337, 9097, 9096, 9098, 2738, 2757, 9100, 9101, 9099, 1805, 2332, 2356, 2346, 2333, 2384, 9041, 9042, 2370, 9044, 9045, 3325, 2381, 3326, 9058, 9059, 9060, 9061, 9062, 9063, 9064, 9065, 9066, 9067, 9068, 9069, 9070, 2358, 3323, 9074, 9076, 9075, 3327, 9047, 9048, 9049, 9050, 9051, 9052, 9053, 9057, 9046, 9054, 9055, 9056, 2359, 2371, 3328, 9071, 9073, 9072, 1810, 3302, 2530, 3300, 9003, 9004, 3297, 8990, 8989, 8991, 3293, 8994, 8995, 8992, 8996, 8993, 2574, 2546, 8998, 8997, 8999, 3301, 9001, 9000, 9002, 2542, 2545, 3410, 3414, 3411, 9014, 9013, 9011, 9012, 3412, 9021, 9022, 3409, 9984, 9982, 3413, 3576, 9028, 9026, 9027, 2535, 3298, 9008, 9007, 9009, 9010, 9005, 9006, 2557, 9018, 9015, 9017, 9016, 2558, 9019, 9020, 3299, 9039, 9037, 9035, 9033, 9034, 9036, 9983, 9981, 9038, 2572, 2536, 9025, 9023, 9024, 2553, 9029, 9030, 9032, 9031, 3296, 3294, 3295, 9555, 2617, 8317, 8319, 8318, 3443, 8320, 8322, 10011, 8321, 3427, 8467, 8466, 8469, 8468, 8470, 3242, 8461, 8465, 8460, 8463, 8462, 8464, 2310, 8844, 8843, 2685, 8970, 9850, 8971, 9849, 8969, 9949, 1812, 2678, 8917, 8919, 8988, 8921, 8922, 8918, 2629, 8920, 2633, 2696, 2662, 2644, 2635, 8928, 8924, 8925, 8923, 8926, 9542, 8927, 2674, 2697, 2684, 2665, 2631, 2645, 2640, 2655, 2673, 2650, 8931, 8930, 8929, 2683, 3611, 2675, 8934, 8935, 2988, 9637, 2657, 3623, 2670, 2688, 2630, 2677, 2649, 2698, 2654, 2705, 2637, 3588, 8940, 8942, 8941, 3313, 8943, 8944, 3316, 8945, 8946, 8947, 2669, 2651, 2666, 2686, 2643, 8949, 8950, 8948, 8951, 2695, 8952, 8954, 8953, 2660, 9891, 8974, 8975, 8973, 8972, 2667, 2627, 2691, 2656, 2658, 2653, 3246, 8979, 8980, 8981, 8982, 8978, 8983, 8984, 3315, 2636, 2681, 8986, 8985, 8987, 2672, 2652, 2664, 2663, 9575, 3580, 2642, 2676, 2659, 3221, 3167, 2632, 2668, 2703, 2679, 8845, 2710, 3289, 8782, 8784, 8785, 8783, 8864, 9793, 2264, 8755, 8757, 8756, 2308, 2319, 8786, 8787, 2262, 3286, 8836, 8837, 8838, 2271, 9902, 8841, 1814, 2721, 2733, 2726, 2990, 2723, 2734, 3372, 3524, 9776, 9697, 2725, 3525, 2727, 1816, 3304, 2795, 2782, 3305, 6495, 6498, 6501, 6494, 6496, 6493, 6492, 6497, 6506, 6505, 6500, 9990, 6504, 6502, 6507, 6503, 6499, 2816, 9989, 9987, 9988, 9907, 9986, 2779, 3057, 2800, 6527, 6529, 6515, 6516, 6517, 6510, 6518, 6519, 6522, 6521, 6520, 6508, 6523, 6513, 6509, 6511, 6512, 6514, 6528, 6524, 6525, 6526, 2965, 6531, 6532, 6530, 2788, 6542, 6540, 6539, 6537, 6541, 6538, 9848, 6536, 6533, 6535, 6534, 2817, 6548, 6547, 6545, 6543, 6544, 6546, 3415, 6554, 6553, 6551, 6549, 6550, 6552, 3416, 6574, 6576, 6562, 6563, 6564, 6557, 6565, 9818, 6581, 6566, 6569, 6579, 6568, 6582, 6567, 6555, 6570, 6578, 6560, 6556, 6580, 6558, 6559, 6577, 6561, 6575, 6572, 6571, 6573, 2803, 3174, 2778, 6583, 6584, 6585, 6586, 6587, 6588, 6590, 6592, 6593, 6594, 6595, 6596, 6597, 9819, 6598, 6599, 6600, 6601, 6602, 6603, 6604, 6605, 6606, 6607, 6608, 6609, 2808, 6610, 6616, 6611, 6612, 6613, 6614, 6617, 6618, 6619, 6620, 6621, 6622, 6623, 6624, 6625, 6626, 6627, 6628, 6629, 6630, 6631, 6633, 6634, 6635, 6636, 6637, 6638, 6639, 6640, 6641, 6642, 6643, 6644, 6645, 6646, 6647, 6649, 6648, 6650, 6651, 6652, 6653, 6654, 6655, 6656, 6657, 6658, 6659, 6660, 6661, 6662, 6663, 6664, 6665, 6666, 6667, 6668, 6669, 6670, 9820, 6671, 6672, 6673, 6674, 6675, 6676, 6677, 6678, 6679, 6680, 6681, 6682, 2794, 2809, 6764, 6724, 6779, 6706, 6715, 6733, 6707, 6716, 6734, 6729, 6683, 6735, 6684, 6699, 6736, 6685, 6687, 6730, 6686, 6751, 6765, 6766, 6760, 6688, 6778, 6689, 6737, 6725, 6726, 6690, 6691, 6740, 6692, 6746, 6741, 6768, 6745, 6744, 6705, 6747, 6769, 6693, 6770, 6727, 6708, 6694, 6748, 6754, 6728, 6710, 6709, 6704, 6771, 6742, 6695, 6718, 6717, 6772, 6719, 6711, 6712, 6773, 6780, 6703, 6696, 6774, 6720, 6701, 6731, 6721, 6750, 6702, 6732, 6713, 6714, 6700, 6697, 6723, 6738, 6749, 6775, 6776, 6698, 6777, 6722, 6743, 6739, 6758, 6753, 6759, 6755, 6761, 6762, 6757, 6763, 6756, 2796, 3083, 2820, 2822, 6782, 6784, 6783, 6781, 3308, 2798, 2792, 2818, 6804, 6806, 6792, 6793, 6794, 6787, 6795, 9817, 6811, 6796, 6799, 6809, 6798, 6812, 6797, 6785, 6800, 6808, 6790, 6786, 6810, 6788, 6789, 9967, 6807, 6791, 6805, 6802, 6801, 6803, 2783, 2964, 2780, 2804, 3306, 2801, 2802, 2775, 2227, 2234, 2247, 2235, 8295, 8300, 8298, 8296, 9699, 8299, 8297, 3539, 3543, 8301, 8306, 9969, 8304, 8302, 9698, 8305, 8303, 2231, 2244, 2843, 3357, 3513, 8648, 8647, 8646, 3518, 8720, 8721, 8161, 9221, 9645, 8722, 8723, 9962, 3358, 8716, 8717, 8162, 8254, 9646, 8718, 8719, 8210, 8216, 8220, 8222, 8221, 8214, 8224, 8219, 8225, 8213, 8218, 8223, 8215, 8217, 8212, 3530, 9681, 9942, 2866, 9682, 1819, 2893, 3261, 6816, 6817, 6819, 6814, 6818, 6815, 6813, 2909, 4560, 4562, 4565, 4561, 4566, 4563, 4564, 2898, 3263, 2900, 3265, 3629, 4567, 4568, 4570, 4569, 2899, 2916, 2924, 4607, 4608, 4609, 2927, 2879, 2883, 2881, 2886, 2897, 3262, 4613, 4615, 3279, 4610, 4611, 4614, 4618, 4617, 4616, 4612, 2920, 2878, 2894, 2921, 2918, 2890, 4574, 4576, 4575, 2904, 4590, 4589, 4591, 4588, 4587, 4586, 2928, 2882, 3630, 4583, 4581, 4582, 4577, 4584, 4579, 4578, 4585, 2919, 3259, 4602, 4605, 4600, 6820, 4603, 4595, 4598, 4606, 4599, 4596, 4604, 4597) AND (
    (
        'true' AND
    origin.id IS NULL
    )
OR

origin.tree_id = 17

) AND (
    (
        -- Фильтр для пользователей с регионом
    users.origin_id IS NOT NULL AND
    origin.utc_offset=ANY(VALUES (1),(2),(3),(4),(5),(6),(-1))
) OR (
    -- Фильтр для пользователей без региона
'true' = 'true' AND users.origin_id IS NULL
)
) AND users.company_name ~* '(фабрика|завод|комбинат|производств|ооо|оао|зао)' AND NOT users.company_name ~* '(дверей|торгов|магазин|окна|потолки|потолков|двери|гастроном|супермаркет|гипермаркет|агенств|агентст|строящиеся|склад|теплиц|научно|филиал|коммерч|аренд|муп|гуп|монтаж|логистическая|сервис|муниципальное|фгку|тоо|управление|автостоянка|инженер|представитель|автомойка|управляющая|кадастр|касс|авторазбор|-тур|тураген|пто|осмотр|консалт|брокер|реклам|страхов|фсин|такси|красоты|авто|транспорт|ремонт|перевозк|приема|утилизирующая|утилизации|утилизация|обслуживан|служба|сельсовет|пекарня|пекарен|булочная|булочных|грузоперевоз|шоу-рум|студия мебели|дизайн-студия|лесничество|блинная|чебуречная|металлобаза|двутавр|переезд|okna|киоск|бутик|сток-центр|центр|меховой|меховая|РусАлка|Marazzi|Amway|Орифлейм|Тиккурила|газпром|роснефть|трансгаз|исправительное|колония|свадебный|салон|продаж|импортер|дилер|оценочно-экспертная)'
AND (users.phone IS NOT NULL AND users.phone <> '')

ORDER BY users.cold_lead_efficiency_coefficient DESC;